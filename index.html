<!doctype html>
<head>
    <title>MTG Deck</title>
    <script src="https://s3.amazonaws.com/stitch-sdks/js/bundles/4.1.1/stitch.js"></script>
    <style>
        body {
            margin: 0;
        }
        .filters {
            position: fixed;
            width: 100%;
            background: white;
            padding: 8px;
        }
        .deck {
            padding-top: 35px;
        }
    </style>
</head>
<body>
    <div class="filters">
        <select id="color">
            <option value="R">Red</option>
            <option value="U">Blue</option>
            <option value="G">Green</option>
            <option value="B">Black</option>
            <option value="W">White</option>
        </select>
        <input id="cost" />
        <select id="type">
            <option>Creature</option>
            <option>Sorcery</option>
            <option>Instant</option>
            <option>Enchantment</option>
            <option>Artifact</option>
            <option>Land</option>
        </select>
        <button id="previous">Previous</button>
        <button id="next">Next</button>
    </div>
    <div class="deck">
        <div style="display: flex; flex-wrap: wrap; justify-content: center;">
            <div style="padding: 3px">
                <div style="width: 300px; height: 400px; border: 6px solid silver; border-radius: 3px; box-shadow: 0 0 3px 0 grey; display: flex; flex-direction: column; padding: 6px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="width: 10em; height: 1em; background: silver;"></span>
                        <span style="width: 2em; height: 1em; background: silver;"></span>
                    </div>
                    <span style="margin-top: 0.5em; width: 8em; height: 1em; background: silver;"></span>
                    <span style="margin-top: 0.5em; width: 15em; height: 1em; background: silver;"></span>
                    <span style="margin-top: auto; width: 15em; height: 3em; background: silver;"></span>
                    <span style="align-self: flex-end; margin-top: auto; width: 2em; height: 1em; background: silver;"></span>
                </div>
            </div>
            <div style="padding: 3px">
                <div style="width: 300px; height: 400px; border: 6px solid silver; border-radius: 3px; box-shadow: 0 0 3px 0 grey; display: flex; flex-direction: column; padding: 6px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="width: 10em; height: 1em; background: silver;"></span>
                        <span style="width: 2em; height: 1em; background: silver;"></span>
                    </div>
                    <span style="margin-top: 0.5em; width: 8em; height: 1em; background: silver;"></span>
                    <span style="margin-top: 0.5em; width: 15em; height: 1em; background: silver;"></span>
                    <span style="margin-top: auto; width: 15em; height: 3em; background: silver;"></span>
                    <span style="align-self: flex-end; margin-top: auto; width: 2em; height: 1em; background: silver;"></span>
                </div>
            </div>
            <div style="padding: 3px">
                <div style="width: 300px; height: 400px; border: 6px solid silver; border-radius: 3px; box-shadow: 0 0 3px 0 grey; display: flex; flex-direction: column; padding: 6px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="width: 10em; height: 1em; background: silver;"></span>
                        <span style="width: 2em; height: 1em; background: silver;"></span>
                    </div>
                    <span style="margin-top: 0.5em; width: 8em; height: 1em; background: silver;"></span>
                    <span style="margin-top: 0.5em; width: 15em; height: 1em; background: silver;"></span>
                    <span style="margin-top: auto; width: 15em; height: 3em; background: silver;"></span>
                    <span style="align-self: flex-end; margin-top: auto; width: 2em; height: 1em; background: silver;"></span>
                </div>
            </div>
            <div style="padding: 3px">
                <div style="width: 300px; height: 400px; border: 6px solid silver; border-radius: 3px; box-shadow: 0 0 3px 0 grey; display: flex; flex-direction: column; padding: 6px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="width: 10em; height: 1em; background: silver;"></span>
                        <span style="width: 2em; height: 1em; background: silver;"></span>
                    </div>
                    <span style="margin-top: 0.5em; width: 8em; height: 1em; background: silver;"></span>
                    <span style="margin-top: 0.5em; width: 15em; height: 1em; background: silver;"></span>
                    <span style="margin-top: auto; width: 15em; height: 3em; background: silver;"></span>
                    <span style="align-self: flex-end; margin-top: auto; width: 2em; height: 1em; background: silver;"></span>
                </div>
            </div>
            <div style="padding: 3px">
                <div style="width: 300px; height: 400px; border: 6px solid silver; border-radius: 3px; box-shadow: 0 0 3px 0 grey; display: flex; flex-direction: column; padding: 6px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="width: 10em; height: 1em; background: silver;"></span>
                        <span style="width: 2em; height: 1em; background: silver;"></span>
                    </div>
                    <span style="margin-top: 0.5em; width: 8em; height: 1em; background: silver;"></span>
                    <span style="margin-top: 0.5em; width: 15em; height: 1em; background: silver;"></span>
                    <span style="margin-top: auto; width: 15em; height: 3em; background: silver;"></span>
                    <span style="align-self: flex-end; margin-top: auto; width: 2em; height: 1em; background: silver;"></span>
                </div>
            </div>
            <div style="padding: 3px">
                <div style="width: 300px; height: 400px; border: 6px solid silver; border-radius: 3px; box-shadow: 0 0 3px 0 grey; display: flex; flex-direction: column; padding: 6px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="width: 10em; height: 1em; background: silver;"></span>
                        <span style="width: 2em; height: 1em; background: silver;"></span>
                    </div>
                    <span style="margin-top: 0.5em; width: 8em; height: 1em; background: silver;"></span>
                    <span style="margin-top: 0.5em; width: 15em; height: 1em; background: silver;"></span>
                    <span style="margin-top: auto; width: 15em; height: 3em; background: silver;"></span>
                    <span style="align-self: flex-end; margin-top: auto; width: 2em; height: 1em; background: silver;"></span>
                </div>
            </div>
            <div style="padding: 3px">
                <div style="width: 300px; height: 400px; border: 6px solid silver; border-radius: 3px; box-shadow: 0 0 3px 0 grey; display: flex; flex-direction: column; padding: 6px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="width: 10em; height: 1em; background: silver;"></span>
                        <span style="width: 2em; height: 1em; background: silver;"></span>
                    </div>
                    <span style="margin-top: 0.5em; width: 8em; height: 1em; background: silver;"></span>
                    <span style="margin-top: 0.5em; width: 15em; height: 1em; background: silver;"></span>
                    <span style="margin-top: auto; width: 15em; height: 3em; background: silver;"></span>
                    <span style="align-self: flex-end; margin-top: auto; width: 2em; height: 1em; background: silver;"></span>
                </div>
            </div>
            <div style="padding: 3px">
                <div style="width: 300px; height: 400px; border: 6px solid silver; border-radius: 3px; box-shadow: 0 0 3px 0 grey; display: flex; flex-direction: column; padding: 6px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="width: 10em; height: 1em; background: silver;"></span>
                        <span style="width: 2em; height: 1em; background: silver;"></span>
                    </div>
                    <span style="margin-top: 0.5em; width: 8em; height: 1em; background: silver;"></span>
                    <span style="margin-top: 0.5em; width: 15em; height: 1em; background: silver;"></span>
                    <span style="margin-top: auto; width: 15em; height: 3em; background: silver;"></span>
                    <span style="align-self: flex-end; margin-top: auto; width: 2em; height: 1em; background: silver;"></span>
                </div>
            </div>
            <div style="padding: 3px">
                <div style="width: 300px; height: 400px; border: 6px solid silver; border-radius: 3px; box-shadow: 0 0 3px 0 grey; display: flex; flex-direction: column; padding: 6px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="width: 10em; height: 1em; background: silver;"></span>
                        <span style="width: 2em; height: 1em; background: silver;"></span>
                    </div>
                    <span style="margin-top: 0.5em; width: 8em; height: 1em; background: silver;"></span>
                    <span style="margin-top: 0.5em; width: 15em; height: 1em; background: silver;"></span>
                    <span style="margin-top: auto; width: 15em; height: 3em; background: silver;"></span>
                    <span style="align-self: flex-end; margin-top: auto; width: 2em; height: 1em; background: silver;"></span>
                </div>
            </div>
            <div style="padding: 3px">
                <div style="width: 300px; height: 400px; border: 6px solid silver; border-radius: 3px; box-shadow: 0 0 3px 0 grey; display: flex; flex-direction: column; padding: 6px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="width: 10em; height: 1em; background: silver;"></span>
                        <span style="width: 2em; height: 1em; background: silver;"></span>
                    </div>
                    <span style="margin-top: 0.5em; width: 8em; height: 1em; background: silver;"></span>
                    <span style="margin-top: 0.5em; width: 15em; height: 1em; background: silver;"></span>
                    <span style="margin-top: auto; width: 15em; height: 3em; background: silver;"></span>
                    <span style="align-self: flex-end; margin-top: auto; width: 2em; height: 1em; background: silver;"></span>
                </div>
            </div>
        </div>
    </div>
    <script>
        function createCard(doc) {
            const colorHash = {
                B: '#CCC2C0',
                W: '#FFFCD6',
                U: '#AAE0FA',
                G: '#9BD3AE',
                R: '#FAAA8F',
            };

            const bgColorHash = {
                B: '#3d3a39',
                W: '#fffef2',
                U: '#88b3c8',
                G: '#7ca88b',
                R: '#c88872',
            }

            const backgroundColor = doc.colors.reduce((accumulator, current, index, arr) => {
                if (arr.length === 1) {
                    accumulator = accumulator + `${colorHash[current]} 0%, ${colorHash[current]} 100%)`;
                    return accumulator;
                }

                const percentage = parseInt(((index + 1) / arr.length) * 100, 10);

                accumulator = accumulator + `${colorHash[current]} ${percentage}%`;

                if (index + 1 === arr.length) {
                    accumulator = accumulator + ');';
                } else {
                    accumulator = accumulator + ', ';
                }

                return accumulator;
            }, 'background: linear-gradient(135deg, ');

            const creatureStatus = `<span style="align-self: flex-end; margin-top: auto">${doc.power && doc.toughness ? `${doc.power}/${doc.toughness}` : '&nbsp;'}</span>`;

            let costIcons = ['0'];

            if (doc.manaCost) {
                costIcons = doc.manaCost.split('}').map(icon => icon ? `${icon}}` : null).filter(icon => icon);
            }

            const styledCosts = costIcons.reduce((acc, cost) => {
                // console.log(cost);
                const rawCost = cost.replace(/\{|\}+/g, '');
                if (rawCost.match(/[X\d]/g)) {
                    acc = acc + `<span style="border-radius: 100%; color: #fff; background-color: #999999; width: 1.5em; line-height: 1.5; display: inline-block; text-align:center">${rawCost}</span>`;
                }
                if (rawCost.match(/[BWUGR]/g)) {
                    const backgroundColor = bgColorHash[rawCost];
                    const foregroundColor = rawCost === 'W' ? 'black' : 'white';
                    acc = acc + `<span style="border-radius: 100%; color: ${foregroundColor}; background-color: ${backgroundColor}; width: 1.5em; line-height: 1.5; display: inline-block; text-align:center">${rawCost}</span>`;
                }
                return acc;
            }, '');
            // console.log(styledCosts);

            return `
                <div style="padding: 3px">
                    <div style="
                        width: 300px;
                        height: 400px;
                        border: 6px solid ${doc.borderColor};
                        border-radius: 3px;
                        ${backgroundColor};
                        box-shadow: 0 0 3px 0 grey;
                        display: flex;
                        flex-direction: column;
                        padding: 6px;
                    ">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-weight: bold;">${doc.name}</span>
                            <span>${styledCosts}</span>
                        </div>
                        <span>${doc.type}</span>
                        <span>${doc.text}</span>
                        ${doc.flavorText ? `<span style="font-style: italic; margin-top: auto;">${doc.flavorText}</span>` : ''}
                        ${creatureStatus}
                    </div>
                </div>
            `;
        }

        let lastId, secondLastId;

        function fetchDocuments(args = { color: document.querySelector('#color').value, type: document.querySelector('#type').value }) {
            const query = {
                colors: [args.color],
                types: [args.type],
            };

            const projection = {
                limit: 100,
                sort: {
                    _id: -1
                }
            };

            if (lastId) {
                query._id = { $lt: lastId };
            }

            db.collection('cards')
                .find(query, projection)
                .asArray()
                .then(docs => {
                    console.log(
                        "Found docs",
                        lastId,
                        docs.length,
                        docs[0].name,
                        docs[docs.length - 1].name
                    );

                    lastId = docs[docs.length - 1]._id;

                    return docs.map(createCard);
                }).then(cards => {
                    const deck = document.querySelector('.deck');

                    const page = document.createElement('div');
                    page.style = 'display: flex; flex-wrap: wrap; justify-content: center;';
                    cards.forEach((card) => page.appendChild(document.createRange().createContextualFragment(card)));

                    deck.replaceChild(page, deck.firstElementChild);
                }).catch(err => {
                    console.error(err);
                });
        }

        const client = stitch.Stitch.initializeDefaultAppClient('deck-cvaoy');
        const db = client.getServiceClient(stitch.RemoteMongoClient.factory, 'mongodb-atlas').db('mtg');

        client.auth.loginWithCredential(new stitch.AnonymousCredential()).then(user => {
            console.log('User: ', user.id);
            fetchDocuments();
        }).catch(err => {
            console.error(err);
        });

        document.querySelector('#color').addEventListener('change', (e) => {
            console.log(e.target.value);
            fetchDocuments();
        });
        document.querySelector('#type').addEventListener('change', (e) => {
            console.log(e.target.value);
            fetchDocuments();
        });
        document.querySelector('#previous').addEventListener('click', fetchDocuments);
        document.querySelector('#next').addEventListener('click', fetchDocuments);
    </script>
</body>
